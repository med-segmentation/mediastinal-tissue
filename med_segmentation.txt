import os
import subprocess
import logging
import nibabel as nib
import csv
import numpy as np
import SimpleITK as sitk
from totalsegmentator.python_api import totalsegmentator
from skimage.morphology import convex_hull_image 
from scipy.ndimage import binary_dilation
from scipy.ndimage import binary_erosion
from skimage.morphology import remove_small_objects
from scipy.ndimage import label


def find_ct_folders(base_directory, ct_folder_prefix):
       subdirectories = [os.path.join(base_directory, name) for name in os.listdir(base_directory) if os.path.isdir(os.path.join(base_directory, name))]
       ct_prefix_found = {subdir: False for subdir in subdirectories}
       for subdir in subdirectories:
          for root, dirs, files in os.walk(subdir):
             for dir_name in dirs:
               if dir_name.startswith(ct_folder_prefix):
                  ct_prefix_found[subdir] = True
                  input_ct_path = os.path.normpath(os.path.join(root, dir_name))
                  ct_dcm2nii(input_ct_path)
       for subdir, found in ct_prefix_found.items():        
          if not found: 
            with open(ct_error_log, 'a') as file:
              file.write(f'CT folder not found: {os.path.normpath(subdir)}\n')

def ct_dcm2nii(folder_path):
   command_convert_ct = f'plastimatch convert --input {folder_path} --output-img {os.path.join(folder_path, "planningct.nii")}'
   print(f"Command running: {command_convert_ct}")
   subprocess.run(command_convert_ct, shell = True)
   print(f"Command finished: {command_convert_ct}")

def find_rd_folders(base_directory, rd_folder_prefix):
    subdirectories = [os.path.join(base_directory, name) for name in os.listdir(base_directory) if os.path.isdir(os.path.join(base_directory, name))]
    rd_prefix_found = {subdir: False for subdir in subdirectories}
    for subdir in subdirectories:
      for root, dirs, files in os.walk(subdir):
        for dir_name in dirs:
          if dir_name.startswith(rd_folder_prefix):
            rd_prefix_found[subdir] = True
            input_rd_path = os.path.normpath(os.path.join(root, dir_name))
            rd_dcm2nii(input_rd_path)
    for subdir, found in rd_prefix_found.items():        
      if not found: 
        with open(rd_error_log, 'a') as file:
          file.write(f'RTDOSE folder not found: {os.path.normpath(subdir)}\n')

def rd_dcm2nii(folder_path):
   print(f"RD folder: {folder_path}")
   command_convert_rd = f'plastimatch convert --input {folder_path} --output-dose-img {os.path.join(folder_path, "dose.nii")}'
   print(f"Command running: {command_convert_rd}")
   subprocess.run(command_convert_rd, shell = True)
   print(f"Command finished: {command_convert_rd}")

def find_struct_folders_and_files(base_directory, ct_folder_prefix, struct_folder_prefix, struct_file_prefix):
    subdirectories = [os.path.join(base_directory, name) for name in os.listdir(base_directory) if os.path.isdir(os.path.join(base_directory, name))]
    struct_prefix_found = {subdir: False for subdir in subdirectories}
    for subdir in subdirectories:
      for root, dirs, files in os.walk(subdir):
        for dir_name in dirs:
          if dir_name.startswith(ct_folder_prefix):
            input_ct_folder_path = os.path.normpath(os.path.join(root, dir_name))
          if dir_name.startswith(struct_folder_prefix):
            input_struct_folder_path = os.path.normpath(os.path.join(root, dir_name))
            struct_prefix_found[subdir] = True
            with open(struct_folders, 'a') as file:
              file.write(f'{input_struct_folder_path}\n')
            for file in os.listdir(input_struct_folder_path):
              if file.startswith(struct_file_prefix):
                 input_struct_file_path = os.path.normpath(os.path.join(input_struct_folder_path, file))
                 struct_dcm2nii(input_struct_file_path, input_struct_folder_path, input_ct_folder_path)
    for subdir, found in struct_prefix_found.items():
       if not found: 
          with open(struct_error_log, 'a') as file:
           file.write(f'RTSTRUCT folder not found: {os.path.normpath(subdir)}\n')          

def struct_dcm2nii(file_path, folder_path, ct_folder_path):
   print(f"RTSTRUCT folder: {folder_path}")
   command_convert_struct = f'plastimatch convert --input {file_path} --output-prefix {folder_path} --fixed {os.path.join(ct_folder_path, "planningct.nii")} --prefix-format nii'
   print(f"Command running: {command_convert_struct}")
   subprocess.run(command_convert_struct, shell = True)
   print(f"Command finished: {command_convert_struct}")

def segmentation(base_directory, ct_folder_prefix, struct_folder_prefix):
      subdirectories = [os.path.join(base_directory, name) for name in os.listdir(base_directory) if os.path.isdir(os.path.join(base_directory, name))]
      for subdir in subdirectories:
        for root, dirs, files in os.walk(subdir):
          for dir_name in dirs:
            if dir_name.startswith(ct_folder_prefix):
              input_ct_folder_path = os.path.join(root, dir_name)
              input_ct_file_path = os.path.join(input_ct_folder_path, "planningct.nii")
            if dir_name.startswith(struct_folder_prefix):
              struct_seg_folder_path = os.path.join(root, dir_name)
              output_segment_path = os.path.join(struct_seg_folder_path, "segmented")
              if not os.path.exists(output_segment_path):
                os.makedirs(output_segment_path)
        print(f"CT file path: {input_ct_file_path}")
        print(f"Output seg path: {output_segment_path}")
        totalsegmentator(input_ct_file_path, output_segment_path)
      print(f"Completed.")

def mediastinum(base_directory, subdir_folders2, struct_folder_prefix):
      with open(subdir_folders2, 'r') as file:
          subdirectories = [line.strip() for line in file if line.strip()]
      #subdirectories = [os.path.join(base_directory, name) for name in os.listdir(base_directory) if os.path.isdir(os.path.join(base_directory, name))]
      for subdir in subdirectories:
        for root, dirs, files in os.walk(subdir):
          for dir_name in dirs:
            if dir_name.startswith(struct_folder_prefix):
              struct_seg_folder_path = os.path.join(root, dir_name)
              segmented_folder_path = os.path.join(struct_seg_folder_path, "segmented")
              cardiovascular = os.path.join(segmented_folder_path, "cardiovascular.nii.gz")
              command_cardioAdd = f'plastimatch add --output {cardiovascular} {os.path.join(segmented_folder_path, "aorta.nii.gz")} {os.path.join(segmented_folder_path, "brachiocephalic_trunk.nii.gz")} {os.path.join(segmented_folder_path, "brachiocephalic_vein_left.nii.gz")} {os.path.join(segmented_folder_path, "brachiocephalic_vein_right.nii.gz")} {os.path.join(segmented_folder_path, "common_carotid_artery_left.nii.gz")} {os.path.join(segmented_folder_path, "common_carotid_artery_right.nii.gz")} {os.path.join(segmented_folder_path, "heart.nii.gz")} {os.path.join(segmented_folder_path, "inferior_vena_cava.nii.gz")} {os.path.join(segmented_folder_path, "pulmonary_vein.nii.gz")} {os.path.join(segmented_folder_path, "subclavian_artery_left.nii.gz")} {os.path.join(segmented_folder_path, "subclavian_artery_right.nii.gz")} {os.path.join(segmented_folder_path, "superior_vena_cava.nii.gz")}'
              print(f"Command running: {command_cardioAdd}")
              subprocess.run(command_cardioAdd, shell = True)
              lungs = os.path.join(segmented_folder_path, "lungs.nii.gz")
              command_lungsAdd = f'plastimatch add --output {lungs} {os.path.join(segmented_folder_path, "lung_upper_lobe_right.nii.gz")} {os.path.join(segmented_folder_path, "lung_upper_lobe_left.nii.gz")} {os.path.join(segmented_folder_path, "lung_middle_lobe_right.nii.gz")} {os.path.join(segmented_folder_path, "lung_lower_lobe_right.nii.gz")} {os.path.join(segmented_folder_path, "lung_lower_lobe_left.nii.gz")}'
              print(f"Command running: {command_lungsAdd}")
              subprocess.run(command_lungsAdd, shell = True)
              vertebrae = os.path.join(segmented_folder_path, "vertebrae.nii.gz")
              command_vertebraeAdd = f'plastimatch add --output {vertebrae} {os.path.join(segmented_folder_path, "vertebrae_C1.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_C2.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_C3.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_C4.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_C5.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_C6.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_C7.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_T1.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_T2.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_T3.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_T4.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_T5.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_T6.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_T7.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_T8.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_T9.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_T10.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_T11.nii.gz")} {os.path.join(segmented_folder_path, "vertebrae_T12.nii.gz")}'
              print(f"Command running: {command_vertebraeAdd}")
              subprocess.run(command_vertebraeAdd, shell = True)

              ## processing vertebrae ## 
              vertebrae_path = os.path.join(segmented_folder_path, "vertebrae.nii.gz")
              vertebrae = nib.load(vertebrae_path)
              vertebrae_data = vertebrae.get_fdata()
              convex_hull_3d = np.zeros_like(vertebrae_data)
              for i in range(vertebrae_data.shape[-1]):  
                 slice_2d = vertebrae_data[:, :, i]
                 if np.any(slice_2d):
                    convex_hull_3d[:, :, i] = convex_hull_image(slice_2d)
                 else:
                    convex_hull_3d[:, :, i] = slice_2d
              convex_hull_3d = convex_hull_3d.astype(np.int8)
              structuring_element = np.zeros((150, 21, 1))
              structuring_element[:, 11:, 0] = True
              structuring_element[:, 10, 0] = True
              dilated_convex_hull_3d = binary_dilation(convex_hull_3d, structure = structuring_element)
              dilated_convex_hull_3d = dilated_convex_hull_3d.astype(np.int8)
              chull_vertebrae = nib.Nifti1Image(dilated_convex_hull_3d, affine=vertebrae.affine)
              output_chull_vertebrae = os.path.join(segmented_folder_path, "chull_vertebrae.nii.gz")
              nib.save(chull_vertebrae, output_chull_vertebrae)
              print("c hull vertebrae saved")
              
              ## processing lungs
              lungs_path = os.path.join(segmented_folder_path, "lungs.nii.gz")
              lungs = nib.load(lungs_path)
              lungs_data = lungs.get_fdata()
              convex_hull_3d = np.zeros_like(lungs_data)
              for i in range(lungs_data.shape[-1]):  
                 slice_2d = lungs_data[:, :, i]
                 if np.any(slice_2d):
                    convex_hull_3d[:, :, i] = convex_hull_image(slice_2d)
                 else:
                    convex_hull_3d[:, :, i] = slice_2d 
              convex_hull_3d = convex_hull_3d.astype(np.int8)
              chull_lungs = nib.Nifti1Image(convex_hull_3d, affine=lungs.affine)
              output_chull_lungs = os.path.join(segmented_folder_path, "chull_lungs.nii.gz")
              nib.save(chull_lungs, output_chull_lungs)
              print("c hull lungs saved")

              ## segmenting mediastinum #1
              output_chull_lungs = os.path.join(segmented_folder_path, "chull_lungs.nii.gz")
              chull_lungs = nib.load(output_chull_lungs)
              chull_lungs_data = chull_lungs.get_fdata()
              output_chull_vertebrae = os.path.join(segmented_folder_path, "chull_vertebrae.nii.gz")
              chull_vertebrae = nib.load(output_chull_vertebrae)
              chull_vertebrae_data = chull_vertebrae.get_fdata()
              cardiovascular_path = os.path.join(segmented_folder_path, "cardiovascular.nii.gz")
              cardiovascular = nib.load(cardiovascular_path)
              cardiovascular_data = cardiovascular.get_fdata()
              lungs_path = os.path.join(segmented_folder_path, "lungs.nii.gz")
              lungs = nib.load(lungs_path)
              lungs_data = lungs.get_fdata()
              heart_path = os.path.join(struct_seg_folder_path, "HEART.nii")
              heart = nib.load(heart_path)
              heart_data = heart.get_fdata()
              dilated_heart_data = np.zeros_like(heart_data)
              structuring_element_heart = np.zeros((10, 10), dtype=bool)
              structuring_element_heart[0, 8] = 1  # pos y
              structuring_element_heart[1, 8] = 1  # more pos y
              structuring_element_heart[2, 8] = 1  # more pos y
              structuring_element_heart[3, 8] = 1  # more pos y
              structuring_element_heart[8, 4] = 1  # neg y
              structuring_element_heart[4, 8] = 1  # pos x
              structuring_element_heart[8, 0] = 1  # neg x
              structuring_element_heart[4, 4] = 1  # center
              for z in range(heart_data.shape[2]):
                 slice_2d = heart_data[:, :, z]
                 dilated_slice = binary_dilation(slice_2d, structure=structuring_element_heart)
                 dilated_heart_data[:, :, z] = dilated_slice
              trachea = os.path.join(segmented_folder_path, "trachea.nii.gz")
              trachea = nib.load(trachea)
              trachea_data = trachea.get_fdata()
              esophagus = os.path.join(segmented_folder_path, "esophagus.nii.gz")
              esophagus = nib.load(esophagus)
              esophagus_data = esophagus.get_fdata()               
              mediastinum_data = chull_lungs_data - lungs_data - chull_vertebrae_data - cardiovascular_data - dilated_heart_data - trachea_data - esophagus_data
              mediastinum_data = np.clip(mediastinum_data, 0, None)
              mediastinum = nib.Nifti1Image(mediastinum_data, affine=chull_lungs.affine)
              nib.save(mediastinum, os.path.join(segmented_folder_path, "mediastinum.nii.gz"))
              print(f"mediastinum img saved") 

              ## removing small mediastinum parts 
              mediastinum = nib.load(os.path.join(segmented_folder_path, "mediastinum.nii.gz"))
              mediastinum_data = mediastinum.get_fdata()
              binary_mediastinum_data = mediastinum_data > 0.5
              cleaned_img_data = np.zeros_like(mediastinum_data)
              min_size = 100
              for z in range(binary_mediastinum_data.shape[2]):
                  slice_2d = binary_mediastinum_data[:, :, z]
                  cleaned_slice = remove_small_objects(slice_2d, min_size=min_size)
                  cleaned_img_data[:, :, z] = cleaned_slice
              ##eroded_mediastinum = remove_small_objects(binary_mediastinum_data, min_size=min_size) ## not used
              cleaned_img_data = nib.Nifti1Image(cleaned_img_data.astype(np.uint8), affine = mediastinum.affine)
              nib.save(cleaned_img_data, os.path.join(segmented_folder_path, "eroded_mediastinum.nii.gz"))
              print(f"eroded mediastinum img saved")

              ## removing everything above the midplane of the heart 
              heart_path = os.path.join(struct_seg_folder_path, "HEART.nii")
              heart = nib.load(heart_path)
              heart_data = heart.get_fdata()
              eroded_mediastinum = nib.load(os.path.join(segmented_folder_path, "eroded_mediastinum.nii.gz"))
              eroded_mediastinum_data = eroded_mediastinum.get_fdata().astype(bool)
              print(f"Struct1 shape: {heart_data.shape}")
              print(f"Struct2 shape: {eroded_mediastinum_data.shape}")
              if heart_data.shape != eroded_mediastinum_data.shape:
                   raise ValueError("Struct1 and Struct2 must have the same dimensions. Please align or resample them.")
              heart_mask = (heart_data == 1)
              x_values, y_values, z_values = np.where(heart_mask)
              if len(y_values) == 0:
                raise ValueError("Heart does not contain any values of 1.")
              min_y = np.min(y_values)
              max_y = np.max(y_values)
              mid_y = round(0.5*(max_y + min_y))
              print(f"Heart has values of 1 from y = {np.max(y_values)} to y = {min_y}")
              eroded_mediastinum_data[:, :mid_y+1, :] = 0
              mod_mediastinum_data = nib.Nifti1Image(eroded_mediastinum_data.astype(np.uint8), affine=eroded_mediastinum.affine)
              nib.save(mod_mediastinum_data, os.path.join(segmented_folder_path, "mod_mediastinum.nii.gz"))
              print(f"mod mediastinum saved")

              ## removing lower slices of eroded mediastinum
              ## 1. truncating at the upper liver slice
              liver = nib.load(os.path.join(segmented_folder_path, "liver.nii.gz"))
              liver_data = liver.get_fdata()
              
              labeled_liver_data, num_features = label(liver_data, structure = np.ones((3,3,3)))
              sizes_liver = np.bincount(labeled_liver_data.ravel())
              size_thresh_liver = 1000
              mask_liver = sizes_liver >= size_thresh_liver
              mask_liver[0] = False
              filtered_liver_data = mask_liver[labeled_liver_data]

              trunc_mediastinum = nib.load(os.path.join(segmented_folder_path, "mod_mediastinum.nii.gz")) # eroded_mediastinum OR mod_mediastinum from a previous snippet
              trunc_mediastinum_data = trunc_mediastinum.get_fdata()
              x_dim, y_dim, z_dim = trunc_mediastinum_data.shape
              for z in range(z_dim -1, -1, -1):
                  if np.any(filtered_liver_data[:, :, z]):
                      liver_data_plane_z = z
                      break 
              mod_mediastinum = np.copy(trunc_mediastinum_data)
              mod_mediastinum[:, :,  :liver_data_plane_z] = 0
              print(f"{liver_data_plane_z}")
              if liver_data_plane_z != -1:  
                 print("No non-empty planes found.")  # O
              truncated_mediastinum = nib.Nifti1Image(mod_mediastinum.astype(np.uint8), affine=trunc_mediastinum.affine)
              nib.save(truncated_mediastinum, os.path.join(segmented_folder_path, "truncated_mediastinum.nii.gz"))
              print(f"truncated mediastinum saved")
              ## 2. replacing the bottom 5 slices with zeros
              trunc2_mediastinum = os.path.join(segmented_folder_path, "truncated_mediastinum.nii.gz")
              trunc2_mediastinum = nib.load(trunc2_mediastinum)
              mediastinum_mod_data = trunc2_mediastinum.get_fdata()
              x_dim, y_dim, z_dim = mediastinum_mod_data.shape
              non_zero_slices = [z for z in range(z_dim) if np.any(mediastinum_mod_data[:, :, z] != 0)]
              if len(non_zero_slices) >= 5:   ## 5 in the orig
                 slices_to_replace = non_zero_slices[:5]
                 for z in slices_to_replace:
                     mediastinum_mod_data[:, :, z] = 0
              else:
                 raise ValueError("Not enough non-zero slices.")
              truncated2_mediastinum = nib.Nifti1Image(mediastinum_mod_data.astype(np.uint8), affine=trunc2_mediastinum.affine)
              nib.save(truncated2_mediastinum, os.path.join(segmented_folder_path, "truncated2_mediastinum.nii.gz"))
              print(f"2x truncated mediastinum saved")
  
              ## mediastinum above heart 
              heart_path = os.path.join(struct_seg_folder_path, "HEART.nii")
              heart = nib.load(heart_path)
              heart_data = heart.get_fdata()
              eroded_mediastinum = nib.load(os.path.join(segmented_folder_path, "eroded_mediastinum.nii.gz"))
              eroded_mediastinum_data = eroded_mediastinum.get_fdata().astype(bool)
              x_dim, y_dim, z_dim = eroded_mediastinum_data.shape
              for z in range(z_dim -1, -1, -1):
                  if np.any(heart_data[:, :, z]):
                      heart_data_plane_z = z
                      break 
              mod_mediastinum = np.copy(eroded_mediastinum_data)
              mod_mediastinum[:, :,  :heart_data_plane_z] = 0
              trunc_upper_mediastinum = nib.Nifti1Image(mod_mediastinum.astype(np.uint8), affine=eroded_mediastinum.affine)
              nib.save(trunc_upper_mediastinum, os.path.join(segmented_folder_path, "trunc_upper_mediastinum.nii.gz"))
              print(f"truncated upper mediastinum saved")

              ## checking if GTV-N and GTV-T exist
              shape_mediastinum = nib.load(os.path.join(segmented_folder_path, "mediastinum.nii.gz"))
              shape_mediastinum_data = shape_mediastinum.get_fdata()
              shape = shape_mediastinum_data.shape

              summed_GTV_volume = None
              with open(gtv_file_path, mode='r') as csv_file:
                  csv_reader = csv.reader(csv_file)
                  next(csv_reader)
                  reference_image = None
                  for row in csv_reader:
                    file_name = row[0]
                    GTV_file_path = os.path.abspath(file_name)
                    #print(f"GTV path: {GTV_file_path}")
                    #print(f"sruct path: {os.path.normpath(struct_seg_folder_path)}")
                    if os.path.exists(GTV_file_path) and os.path.commonpath([GTV_file_path, os.path.normpath(struct_seg_folder_path)]) == os.path.normpath(struct_seg_folder_path):
                      #print(f"reading: {GTV_file_path}")
                      #print(f"full path: {struct_seg_folder_path}")
                      image = sitk.ReadImage(GTV_file_path)
                      if reference_image is None:
                         reference_image = image
                         summed_GTV_volume = sitk.GetArrayFromImage(image)
                         continue
                      resampled_image = sitk.Resample(image, reference_image)
                      array = sitk.GetArrayFromImage(resampled_image)
                      summed_GTV_volume += array

              #print(f"summed: {summed_GTV_volume}")
              #print(f"Summed volume shape: {summed_GTV_volume.shape}, unique values: {np.unique(summed_GTV_volume)}")
              summed_GTV_volume[summed_GTV_volume > 0] = 1
              summed_GTV_image = sitk.GetImageFromArray(summed_GTV_volume)
              summed_GTV_image.CopyInformation(reference_image)
              sitk.WriteImage(summed_GTV_image, os.path.join(segmented_folder_path, "combined_GTV_volume.nii.gz"))

              ## entire mediastinum
              truncated2_mediastinum = nib.load(os.path.join(segmented_folder_path, "truncated2_mediastinum.nii.gz"))
              truncated2_mediastinum_data = truncated2_mediastinum.get_fdata()
              trunc_upper_mediastinum = nib.load(os.path.join(segmented_folder_path, "trunc_upper_mediastinum.nii.gz"))
              trunc_upper_mediastinum_data = trunc_upper_mediastinum.get_fdata()
              combined_GTV = nib.load(os.path.join(segmented_folder_path, "combined_GTV_volume.nii.gz"))
              combined_GTV_data = combined_GTV.get_fdata()
              final_mediastinum_data = truncated2_mediastinum_data + trunc_upper_mediastinum_data 
              final_mediastinum = nib.Nifti1Image((final_mediastinum_data > 0.5).astype(np.uint8), affine=truncated2_mediastinum.affine)
              nib.save(final_mediastinum, os.path.join(segmented_folder_path, "final_mediastinum_withGTV.nii.gz"))
              print(f"final mediastinum img with GTV saved")
              final_mediastinum2 = nib.load(os.path.join(segmented_folder_path, "final_mediastinum_withGTV.nii.gz"))
              final_mediastinum2_data = final_mediastinum2.get_fdata()
              final_mediastinum3_data = final_mediastinum2_data - combined_GTV_data
              final_mediastinum3 = nib.Nifti1Image((final_mediastinum3_data > 0.5).astype(np.uint8), affine=final_mediastinum2.affine)
              nib.save(final_mediastinum3, os.path.join(segmented_folder_path, "final_mediastinum.nii.gz"))
              print(f"final mediastinum img saved")

              ## lungs-GTV 
              lungs = nib.load(os.path.join(segmented_folder_path, "lungs.nii.gz"))
              lungs_data = lungs.get_fdata()
              combined_GTV = nib.load(os.path.join(segmented_folder_path, "combined_GTV_volume.nii.gz"))
              combined_GTV_data = combined_GTV.get_fdata()
              lungs_GTV_data = lungs_data - combined_GTV_data
              lungs_GTV = nib.Nifti1Image((lungs_GTV_data > 0.5).astype(np.uint8), affine=lungs.affine)
              nib.save(lungs_GTV, os.path.join(segmented_folder_path, "lungs_GTV.nii.gz"))
              print(f"lungs-GTV img saved")

              ## removing small mediastinum parts final2
              mediastinum = nib.load(os.path.join(segmented_folder_path, "final_mediastinum.nii.gz"))
              mediastinum_data = mediastinum.get_fdata()
              binary_mediastinum_data = mediastinum_data > 0.5
              cleaned_img_data = np.zeros_like(mediastinum_data)
              min_size = 100
              for z in range(binary_mediastinum_data.shape[2]):
                  slice_2d = binary_mediastinum_data[:, :, z]
                  cleaned_slice = remove_small_objects(slice_2d, min_size=min_size)
                  cleaned_img_data[:, :, z] = cleaned_slice
              eroded_mediastinum = remove_small_objects(binary_mediastinum_data, min_size=min_size)
              cleaned_img_data = nib.Nifti1Image(cleaned_img_data.astype(np.uint8), affine = mediastinum.affine)
              nib.save(cleaned_img_data, os.path.join(segmented_folder_path, "final_mediastinum2.nii.gz"))
              print(f"eroded mediastinum img2 saved")

base_directory = '//base_directory' #specify relevant directory
ct_error_log = '//base_directory/ct_error_log.txt'
rd_error_log = '//base_directory/rd_error_log.txt'
struct_error_log = '//base_directory/struct_error_log.txt'
#struct_folders = '//base_directory/struct_folders.txt'
subdir_folders2 = '//sbase_directory/subdir_folders2.txt'
ct_folder_prefix = 'CT'
rd_folder_prefix = 'RTDOSE'
struct_folder_prefix = 'RTSTRUCT'
struct_file_prefix = 'RTSTRUCT'
gtv_file_path = '//base_directory/struct_list_GTV_pruned.csv'
#find_ct_folders(base_directory, ct_folder_prefix)
#find_rd_folders(base_directory, rd_folder_prefix)
#find_struct_folders_and_files(base_directory, ct_folder_prefix, struct_folder_prefix, struct_file_prefix)

## segmentation 

#if __name__ == "__main__":
#   ct_folder_prefix = 'CT'
#   struct_folder_prefix = 'RTSTRUCT'
#   segmentation(base_directory, ct_folder_prefix, struct_folder_prefix)

## mediastinum 

mediastinum(base_directory, subdir_folders2, struct_folder_prefix)

